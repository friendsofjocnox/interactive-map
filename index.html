<!DOCTYPE html>
<html>
<head>
    <title>Global RTS Multiplayer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html, #map { margin: 0; height: 100%; background: #001529; }
        #ui { position: absolute; top: 10px; left: 50px; z-index: 1000; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; border: 1px solid #0f0; font-family: monospace; pointer-events: none; }
    </style>
</head>
<body>
    <div id="ui">
        <b>WORLD CONQUEST: MULTIPLAYER</b><br>
        Status: <span id="conn-status">Connecting...</span><br>
        Units: Right-Click map to deploy/move.
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- MAP SETUP ---
        const map = L.map('map', { attributionControl: false }).setView([20, 0], 3);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        // --- GAME STATE ---
        const myClientId = Math.random().toString(36).substring(7);
        const myTeam = ['blue', 'red', 'green', 'gold'][Math.floor(Math.random() * 4)];
        const units = {}; // Global store: { unitId: LeafletMarker }

        const channel = supabase.channel('world-war-1', {
            config: { broadcast: { self: true } }
        });

        // --- MULTIPLAYER LOGIC ---
        channel
            .on('broadcast', { event: 'move' }, ({ payload }) => {
                updateUnitPosition(payload);
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') document.getElementById('conn-status').innerText = `Online (${myTeam})`;
            });

        function updateUnitPosition(data) {
            const { id, lat, lng, team } = data;
            if (!units[id]) {
                // Create new unit marker
                units[id] = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: team,
                    color: '#fff',
                    fillOpacity: 0.8
                }).addTo(map);
                units[id].bindTooltip(`Team: ${team}`).openTooltip();
            } else {
                // Move existing unit smoothly (Simplified for this demo)
                units[id].setLatLng([lat, lng]);
            }
        }

        // --- INPUTS ---
        map.on('contextmenu', (e) => {
            const unitId = `${myClientId}_${Date.now()}`;
            const moveData = {
                id: unitId,
                lat: e.latlng.lat,
                lng: e.latlng.lng,
                team: myTeam
            };

            // Broadcast move to all players
            channel.send({
                type: 'broadcast',
                event: 'move',
                payload: moveData
            });
        });

        // --- ENEMY AI (Simulated by Host) ---
        // In a real game, the first player in 'presence' would run this.
        setInterval(() => {
            const enemyId = 'ai_bot_1';
            const randomLat = 20 + (Math.random() - 0.5) * 10;
            const randomLng = (Math.random() - 0.5) * 10;
            
            channel.send({
                type: 'broadcast',
                event: 'move',
                payload: { id: enemyId, lat: randomLat, lng: randomLng, team: 'white' }
            });
        }, 3000);

    </script>
</body>
</html>
